# Hobby operating system

 - Mainly developped in C.
 - Boots with UEFI.
 - Does not do anything meaningful.

## This repository

### Source code structure

 - `arch/*`: architecture-specific code
   - `boot`: early boot (after firmware, before kernel_main)
   - `*`: same as non-arch
 - `dev`: device drivers
 - `include`
 - `kernel`: core kernel components (task management, core functions)
 - `lib`: hardware independant code (ELF, string manipulation, generic
   structures)
 - `mm`: memory management

### Other directories

 - `build`: directory generated by `./boot` script for QEMU
 - `scripts`: helper scripts
 - `third_party`: external libraries dependencies

### Utilities

 - `scripts/qemu`: scripts to boot the kernel
 - `scripts/gdb`: scripts to run gdb to debug the kernel (with helpers)
   - helper command `qq`: kill kernel and quit
   - helper command `rbreakif`: like `rbreak` but supports a condition
 - `scripts/screen`: scripts to run gdb and qemu in a screen session
 - `scripts/gdb/qemu-efi.py`: GDB library to load kernel symbols during boot
   - GDB command `efi`: automatically called by `./scripts/gdb/qemu-efi`:
     - load kernel symbols to 2 positions:
       - the address where EFI has loaded the kernel
       - the address where the kernel relocates

## Build

### Dependencies

 - Linux kernel Kconfig: `conf` and `mconf` executables must be in `PATH`

### Compilation

 - Configure with `make menuconfig`
 - Build with `make`

### Run

### Build system

Each directory has:

 - A [`Kconfig` file](https://www.kernel.org/doc/html/latest/kbuild/kconfig-language.html)
 - A `Makefile` which lists needed object files:
   - all files in the `obj-y` variable will be built in the final kernel
   - all files in the `boot-y` variable will be built in the bootloader
     (stage 1 kernel)
   - `Makefile` structure (in order):
     - include `Makefile.flags`
     - define variables (`obj-y`, ...)
     - include `Makefile.rules`
     - define build rules specific to this directory

Compilation generates in each directory:

 - `*.o` files for the final kernel
 - `*.bootloader.o` for the bootloader
 - `modules.o`: all `*.o` files merged
 - `bootloader.o`: all `*.bootloader.o` files merged
 - `*.d` files corresponding to their `*.o` counterpart
